name: CI

on:
  push:
    branches: 
      - "**"
    paths-ignore:
      - ./**/*.md
      - docs/**

  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint & Validate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Need full history for git describe

      - name: Get version info
        id: version
        run: |
          VERSION=$(git describe --tags --always 2>/dev/null || git rev-parse --short HEAD)
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: \`$VERSION\`" >> $GITHUB_STEP_SUMMARY

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Lint with Ruff
        run: |
          ruff check firmware/dev/ --ignore=E501,F401,E402

      - name: Check Python syntax
        run: |
          find firmware/dev -name "*.py" -not -path "*/experiments/*" -exec python -m py_compile {} \;

      - name: CircuitPython 7.x compatibility guard
        run: |
          # Flag Python features that CircuitPython 7.x doesn't support.
          # These pass py_compile (valid CPython) but crash on the device.
          ERRORS=0

          # Dict unpacking in literals: {**d, "k": v}
          if grep -rn '{\s*\*\*' firmware/dev/ --include="*.py" | grep -v experiments/; then
            echo "::error::Dict unpacking ({**dict}) is not supported in CircuitPython 7.x"
            ERRORS=$((ERRORS + 1))
          fi

          # Walrus operator: :=
          if grep -rn ':=' firmware/dev/ --include="*.py" | grep -v experiments/; then
            echo "::error::Walrus operator (:=) is not supported in CircuitPython 7.x"
            ERRORS=$((ERRORS + 1))
          fi

          # match/case (Python 3.10+)
          if grep -rn '^[[:space:]]*match ' firmware/dev/ --include="*.py" | grep -v experiments/; then
            echo "::error::match/case is not supported in CircuitPython 7.x"
            ERRORS=$((ERRORS + 1))
          fi

          if [ "$ERRORS" -gt 0 ]; then
            exit 1
          fi
          echo "No CircuitPython compatibility issues found"

      - name: Run tests
        run: |
          python -m pytest tests/ -v --tb=short

  build-zip:
    name: Build Firmware Zip
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: lint
    steps:
      - uses: actions/checkout@v6

      - name: Download mpy-cross for CircuitPython 7.x
        run: |
          # Download the CircuitPython-specific mpy-cross (NOT the MicroPython pip package).
          # The pip `mpy-cross` package produces MicroPython-format .mpy files which are
          # incompatible with CircuitPython. Must use Adafruit's build from S3.
          MPY_CROSS_URL="https://adafruit-circuit-python.s3.amazonaws.com/bin/mpy-cross/linux-amd64/mpy-cross.static-amd64-linux-7.3.3"
          curl -sL "$MPY_CROSS_URL" -o /usr/local/bin/mpy-cross
          chmod +x /usr/local/bin/mpy-cross
          echo "mpy-cross version:"
          mpy-cross --version || true

      - name: Compile .py to .mpy
        run: |
          cd firmware/dev
          # Compile core/ and devices/ modules to .mpy bytecode.
          # This reduces file sizes ~30-50% and eliminates parse/compile
          # time on the device, improving both flash speed and boot time.
          # -O2 strips docstrings and assertions for smallest output.
          for f in core/__init__.py core/button.py core/colors.py core/config.py; do
            mpy-cross -O2 "$f" && rm "$f"
          done
          for f in devices/std10.py devices/mini6.py; do
            mpy-cross -O2 "$f" && rm "$f"
          done
          # Remove empty __init__.py (no value as .mpy)
          rm -f devices/__init__.py
          echo "Compiled .py → .mpy:"
          ls -la core/ devices/

      - name: Write VERSION file
        run: |
          VERSION="${{ needs.lint.outputs.version }}"
          echo "$VERSION" > firmware/dev/VERSION

      - name: Generate firmware manifest
        run: |
          cd firmware/dev
          # Generate checksums for incremental updates. The installer compares
          # this manifest against the device's existing one to skip unchanged files.
          find . -type f \
            -not -name "*.pyc" \
            -not -path "*/__pycache__/*" \
            -not -path "*/experiments/*" \
            -not -name "firmware.md5" \
            | sort \
            | xargs md5sum > firmware.md5
          echo "Generated firmware.md5 with $(wc -l < firmware.md5) entries"

      - name: Create firmware zip
        run: |
          VERSION="${{ needs.lint.outputs.version }}"
          mkdir -p dist
          cd firmware/dev
          zip -r "../../dist/midicaptain-firmware-${VERSION}.zip" \
            INSTALL.txt \
            code.py \
            boot.py \
            config.json \
            config-mini6.json \
            core/ \
            devices/ \
            fonts/ \
            lib/ \
            firmware.md5 \
            VERSION \
            -x "*.pyc" -x "*/__pycache__/*" -x "*/__pycache__" -x "experiments/*"
          cd ../..
          # Add deploy script to root of zip (using -j to strip path)
          zip -j "dist/midicaptain-firmware-${VERSION}.zip" tools/deploy.sh
          echo "Created: \`dist/midicaptain-firmware-${VERSION}.zip\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload zip artifact
        uses: actions/upload-artifact@v6
        with:
          name: firmware-zip
          path: dist/*.zip
          retention-days: 90

  build-config-editor-macos:
    name: Build Config Editor (macOS)
    runs-on: macos-latest
    timeout-minutes: 30
    needs: lint
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Import code signing certificate
        env:
          MACOS_APPLICATION_CERT: ${{ secrets.MACOS_APPLICATION_CERT }}
          MACOS_APPLICATION_CERT_PWD: ${{ secrets.MACOS_APPLICATION_CERT_PWD }}
        run: |
          # Skip if certificate not configured
          if [ -z "$MACOS_APPLICATION_CERT" ]; then
            echo "⚠️ Code signing certificate not configured - building unsigned" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # Import certificate
          echo "$MACOS_APPLICATION_CERT" | base64 --decode > certificate.p12
          security import certificate.p12 -k "$KEYCHAIN_PATH" \
            -P "$MACOS_APPLICATION_CERT_PWD" -T /usr/bin/codesign
          rm certificate.p12
          
          # Set as default keychain
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          echo "✓ Code signing certificate imported" >> $GITHUB_STEP_SUMMARY

      - name: Install frontend dependencies
        run: |
          cd config-editor
          npm install

      - name: Build Tauri app (universal binary)
        env:
          APPLE_SIGNING_IDENTITY: "Developer ID Application: Maximilian Cascone (9WNXKEF4SM)"
        run: |
          cd config-editor
          npm run tauri build -- --target universal-apple-darwin
          ls -lah src-tauri/target/universal-apple-darwin/release/bundle/

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Skip if notarization credentials not configured
          if [ -z "$APPLE_ID" ] || [ -z "$APPLE_APP_PASSWORD" ]; then
            echo "⚠️ Notarization credentials not configured - skipping" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          DMG_PATH=$(find config-editor/src-tauri/target/universal-apple-darwin/release/bundle/dmg -name "*.dmg" | head -1)
          if [ -z "$DMG_PATH" ]; then
            echo "::error::DMG not found after build"
            exit 1
          fi
          
          echo "Notarizing: $DMG_PATH"
          xcrun notarytool submit "$DMG_PATH" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait
          
          echo "Stapling notarization ticket..."
          xcrun stapler staple "$DMG_PATH"
          echo "✓ DMG notarized and stapled" >> $GITHUB_STEP_SUMMARY

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v6
        with:
          name: config-editor-dmg
          path: config-editor/src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
          retention-days: 90

      - name: Upload app bundle artifact
        uses: actions/upload-artifact@v6
        with:
          name: config-editor-app
          path: config-editor/src-tauri/target/universal-apple-darwin/release/bundle/macos/*.app
          retention-days: 90

  build-config-editor-windows:
    name: Build Config Editor (Windows)
    runs-on: windows-latest
    timeout-minutes: 30
    needs: lint
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install frontend dependencies
        run: |
          cd config-editor
          npm install

      - name: Build Tauri app
        run: |
          cd config-editor
          npm run tauri build
          Get-ChildItem -Path src-tauri\target\release\bundle\ -Recurse

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v6
        with:
          name: config-editor-msi
          path: config-editor/src-tauri/target/release/bundle/msi/*.msi
          retention-days: 90

      - name: Upload NSIS artifact
        uses: actions/upload-artifact@v6
        with:
          name: config-editor-nsis
          path: config-editor/src-tauri/target/release/bundle/nsis/*.exe
          retention-days: 90

      - name: Build summary
        shell: bash
        run: |
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✓ Successfully built Config Editor for Windows" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **MSI Installer** (Windows Installer format)" >> $GITHUB_STEP_SUMMARY
          echo "- **NSIS Installer** (Setup executable format)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Notes" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ Builds are unsigned. Users will see Windows SmartScreen warning." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See \`docs/windows-build.md\` for code signing setup." >> $GITHUB_STEP_SUMMARY


name: CI

on:
  push:
    branches: 
      - "**"
    paths-ignore:
      - ./**/*.md
      - docs/**

  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint & Validate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Need full history for git describe

      - name: Get version info
        id: version
        run: |
          VERSION=$(git describe --tags --always 2>/dev/null || git rev-parse --short HEAD)
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: \`$VERSION\`" >> $GITHUB_STEP_SUMMARY

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Lint with Ruff
        run: |
          ruff check firmware/dev/ --ignore=E501,F401,E402

      - name: Check Python syntax
        run: |
          find firmware/dev -name "*.py" -not -path "*/experiments/*" -exec python -m py_compile {} \;

      - name: CircuitPython 7.x compatibility guard
        run: |
          # Flag Python features that CircuitPython 7.x doesn't support.
          # These pass py_compile (valid CPython) but crash on the device.
          ERRORS=0

          # Dict unpacking in literals: {**d, "k": v}
          if grep -rn '{\s*\*\*' firmware/dev/ --include="*.py" | grep -v experiments/; then
            echo "::error::Dict unpacking ({**dict}) is not supported in CircuitPython 7.x"
            ERRORS=$((ERRORS + 1))
          fi

          # Walrus operator: :=
          if grep -rn ':=' firmware/dev/ --include="*.py" | grep -v experiments/; then
            echo "::error::Walrus operator (:=) is not supported in CircuitPython 7.x"
            ERRORS=$((ERRORS + 1))
          fi

          # match/case (Python 3.10+)
          if grep -rn '^[[:space:]]*match ' firmware/dev/ --include="*.py" | grep -v experiments/; then
            echo "::error::match/case is not supported in CircuitPython 7.x"
            ERRORS=$((ERRORS + 1))
          fi

          if [ "$ERRORS" -gt 0 ]; then
            exit 1
          fi
          echo "No CircuitPython compatibility issues found"

      - name: Run tests
        run: |
          python -m pytest tests/ -v --tb=short

  build-zip:
    name: Build Firmware Zip
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: lint
    steps:
      - uses: actions/checkout@v6

      - name: Create firmware zip
        run: |
          VERSION="${{ needs.lint.outputs.version }}"
          mkdir -p dist
          cd firmware/dev
          zip -r "../../dist/midicaptain-firmware-${VERSION}.zip" \
            INSTALL.txt \
            code.py \
            boot.py \
            config.json \
            config-mini6.json \
            core/ \
            devices/ \
            fonts/ \
            -x "*.pyc" -x "*/__pycache__/*" -x "*/__pycache__" -x "experiments/*"
          cd ../..
          echo "Created: \`dist/midicaptain-firmware-${VERSION}.zip\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload zip artifact
        uses: actions/upload-artifact@v6
        with:
          name: firmware-zip
          path: dist/*.zip
          retention-days: 90

